<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8"/>
		<title>SVG path tile rendering demo</title>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
		<style>
			html, body, main {
				height: 100%;
				margin: 0;
			}
			main {
				display: grid;
				&:has(#aspect-portrait:checked) {
					grid-template-columns: 1fr auto;
					grid-template-rows: auto 1fr;
					#canvas-container {
						grid-column: 2;
						grid-row: 1 / span 2;
						overflow-y: auto;
					}
				}
				&:has(#aspect-landscape:checked) {
					grid-template-columns: auto 1fr;
					grid-template-rows: 1fr auto;
					#canvas-container {
						grid-column: 1 / span 2;
						grid-row: 2;
						overflow-x: auto;
					}
				}
			}
			form {
				align-self: center;
				display: grid;
				font-family: system-ui;
				gap: 0.5ch;
				grid-template-columns: auto 1fr;
				margin: 1em;
				ul {
					list-style: none;
					padding: 0;
					margin: 0;
				}
				button[type="submit"] {
					grid-column: span 2;
				}
			}
			path.leaflet-interactive {
				stroke-width: var(--band-width, 3px);
				opacity: 25%;
				stroke-linecap: butt;
			}
			#canvas-container {
				background: repeating-linear-gradient(45deg,#0008,#0000 5em);
			}
			@media (prefers-color-scheme: dark) {
				html {
					color-scheme: dark;
				}
			}
		</style>
	</head>
	<body style="--band-width: 512px;">
		<main>
			<form>
				<label for="path">Path data:</label>
				<textarea id="path" placeholder="longitude,latitude pairs or SVG-style path data"></textarea>
				<label for="bandWidth">Band width:</label>
				<input type="number" id="bandWidth" value="512" min="1" max="10000"/>
				<label for="zoom">Zoom level:</label>
				<input type="number" id="zoom" value="12" min="0" max="24" readonly/>
				<label for="tileUrl">Tile URL:</label>
				<input type="text" id="tileUrl" value="https://tile.openstreetmap.org/{z}/{x}/{y}.png"/>
				<span>Aspect ratio:</span>
				<ul>
					<li><label><input type="radio" name="aspect" id="aspect-portrait" value="portrait" checked/> Portrait</label></li>
					<li><label><input type="radio" name="aspect" id="aspect-landscape" value="landscape"/> Landscape</label></li>
				</ul>
				<label for="smoothness">Smoothness:</label>
				<input type="range" id="smoothness" value="0.2" min="0" max="1" step="0.01"/>
				<button type="submit">Render</button>
			</form>
			<div id="preview">
				<svg>
					<path id="merc-path"/>
				</svg>
			</div>
			<div id="canvas-container">
				<canvas id="canvas" width="512" height="512"></canvas>
			</div>
		</main>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://elfalem.github.io/Leaflet.curve/src/leaflet.curve.js"></script>
		<script type="module">
			const previewMap = L.map("preview").fitWorld();
			const form = document.querySelector("form");
			const pathInput = document.getElementById("path");
			const bandWidthInput = document.getElementById("bandWidth");
			const tileUrlInput = document.getElementById("tileUrl");
			const zoomInput = document.getElementById("zoom");
			const pathEl = document.getElementById("merc-path");
			const canvas = document.getElementById("canvas");
			const tileUrlPreview = L.tileLayer(tileUrlInput.value, {maxZoom: 24}).addTo(previewMap);
			const pathPreview = L.curve([]).addTo(previewMap);
			import { normalizePathData, segmentsToMercatorPath, renderPathTiles } from "./render.js";
			pathInput.addEventListener("change", () => {
				const pathData = pathInput.value;
				let prefix = "M";
				if (pathData.toLowerCase().startsWith("m")) prefix = "";
				const segWgs = normalizePathData(prefix + pathData);
				pathPreview.setPath(segWgs.map(coords => coords.toReversed ? coords.toReversed() : coords));
				previewMap.fitBounds(pathPreview.getBounds());
				const segMerc = segmentsToMercatorPath(segWgs);
				pathEl.setAttribute("d", segMerc.flat().join(" "));
			});
			tileUrlInput.addEventListener("change", () => tileUrlPreview.setUrl(tileUrlInput.value));
			previewMap.on("zoomend", () => zoomInput.value = previewMap.getZoom());
			bandWidthInput.addEventListener("change", () => {
				document.body.style.setProperty("--band-width", `${bandWidthInput.value}px`);
				canvas.width = canvas.height = bandWidthInput.value;
				previewMap.invalidateSize();
			});
			form.addEventListener("submit", e => {
				e.preventDefault();
				renderPathTiles({
					pathEl,
					bandWidth: parseInt(bandWidthInput.value, 10),
					zoom: parseInt(zoomInput.value, 10),
					tileUrl: tileUrlInput.value,
					canvas,
					landscape: document.getElementById("aspect-landscape").checked,
					normalSmoothness: parseFloat(document.getElementById("smoothness").value)
				});
			});
		</script>
	</body>
</html>
